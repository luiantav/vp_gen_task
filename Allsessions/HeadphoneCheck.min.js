/*! HeadphoneCheck 2017-07-27 */

!function(t,e,a){function n(t,i,n){if(L.debug&&console.log("---\x3e "+t+" "+i+", "+n),n!==a){var o="hc-stim-"+i;e("<div/>",{id:o,class:"hc-trial-div"}).appendTo("#"+t),e("<audio/>",{id:"hc-audio-"+i,src:n}).appendTo(e("#"+o)),L.debug&&e("<div/>",{text:"Trial ID: "+i}).appendTo(e("#"+o));var r=e("#"+o).css("background-color");e("<div/>",{id:"hc-play-button-border-"+i}).css({border:"3px solid "+r,display:"inline-block"}).append(e("<button/>",{id:"hc-play-button-"+i,text:"Play",disabled:!1,click:function(){w||s(i)}})).appendTo(e("#"+o)),e("<div/>",{id:"hc-radio-buttonset-"+i,class:"hc-buttonset-vertical"}).appendTo(e("#"+o));var c=[{id:"1",name:"FIRST sound was SOFTEST"},{id:"2",name:"SECOND sound was SOFTEST"},{id:"3",name:"THIRD sound was SOFTEST"}];e.each(c,function(){e("#hc-radio-buttonset-"+i).append(e("<label/>",{for:"hc-radio"+this.id+"-stim-"+i,class:"hc-radio-label",text:this.name}).prepend(e("<input/>",{type:"radio",id:"hc-radio"+this.id+"-stim-"+i,name:"hc-radio-response-"+i,class:"hc-radio-response",value:this.id})))})}}function o(){e("#hc-container").empty()}function r(t){if(t===a?e.each(D,function(t,e){L[t]=e}):e.each(D,function(e,a){L[e]=e in t?t[e]:a}),L.correctThreshold<0)throw new Error("headphoneCheckConfig.correctThreshold must be positive.");L.correctThreshold>1&&(L.correctThreshold/=L.stimIDList.length)}function c(){if(L.totalTrials<=0)throw new Error("headphoneCheckConfig.totalTrials must be positive.");if(L.trialsPerPage<=0)throw new Error("headphoneCheckConfig.trialsPerPage must be positive.");if(L.correctThreshold>L.totalTrials)throw new Error("headphoneCheckConfig.correctThreshold cannot be greater than headphoneCheckConfig.totalTrials.");e(document).trigger("hcInitialized",{data:P,config:L})}function s(t){var i=/trial(\d+)/.exec(t)[1]-1;if(L.useSequential&&i>=0&&f(P.stimIDList[i])===a&&P.trialScoreList[i]===a)e("#hc-stim-"+P.stimIDList[i]).css("border-color",k);else{d("hc-play-button-"+t);var n="hc-audio-"+t;e("#"+n).on("ended",function(){w=!1,y&&e("#hc-radio-buttonset-"+t).css("pointer-events","auto")});var o=e("#hc-play-button-border-"+t).parent().css("background-color");e("#hc-play-button-border-"+t).css("border-color",o),e("#"+n).get(0).play(),w=!0,e("#hc-radio-buttonset-"+t).css("pointer-events","none")}}function d(t){e("#"+t).prop("disabled",!0)}function l(t){e("#"+t).on("ended",function(){w=!1,e("#hc-calibration-continue-button").prop("disabled",!1)}),e("#"+t).get(0).play(),w=!0}function h(){return e(".hc-buttonset-vertical>label>input[type=radio]:checked").length>=e(".hc-buttonset-vertical").length}function u(){var t=e(".hc-buttonset-vertical>label>input[type=radio]:checked").parent().parent(),a=e(".hc-buttonset-vertical>label>input[type=radio]").not(":checked").parent().parent(),i=e(a).not(t).parent();e(t).parent().css("border","5px solid "+S),e(i).css("border","5px solid "+k)}function p(t){return m(P.trialScoreList)/P.stimIDList.length>=t}function m(t){return t.reduce(function(t,e){return t+(e===a?0:e)},0)}function b(t,e,i){if(i!==a){var n=e.correct==i?1:0;return P.trialScoreList[t]=n,P.responseList[t]=i,n}}function f(t){return e("#hc-radio-buttonset-"+t+">label>input:checked").val()}function g(t,e,a){var i=a?v(t,e):T(t,e);P.stimDataList=i,P.stimIDList=P.stimDataList.map(function(t,e){return"trial"+e+"-src"+t.id}),P.trialScoreList=Array(P.stimDataList.length)}function v(t,e){samples=[];for(var a=0;a<e;a++)ind=C(0,t.length,1),samples.push(t[ind]);return samples}function T(t,e){e===a?e=t.length:e<=0?(e=t.length,console.warn("Requested samples is not greater than 0. Using full array.")):e>t.length&&(e=t.length,console.warn("Requested more samples than there are available; use sampleWithReplacement. Using full array."));for(var i,n,o=e,r=t.length;0!==r;)n=Math.floor(Math.random()*r),i=t[r-=1],t[r]=t[n],t[n]=i;return t.slice(0,o)}function C(t,e,a){for(var i=[],n=Math.min(t,e),o=Math.max(t,e),r=0;r<a;r++)i.push(Math.floor(n+(o-n)*Math.random()));return outVal=1==a?i[0]:i,outVal}var S="black",k="red",y=!0,w=!1,P={pageNum:0,stimIDList:[],stimDataList:[],trialScoreList:[],responseList:[],calibration:[],jsonData:a,lastPage:a,totalCorrect:a,didPass:a},L={},D={jsonPath:a,totalTrials:6,trialsPerPage:3,correctThreshold:5/6,useSequential:!0,doShuffleTrials:!0,sampleWithReplacement:!0,doCalibration:!0,debug:!1};t.runHeadphoneCheck=function(a){r(a),c(),e(document).on("hcCalibrationStart",function(e,a){t.renderHeadphoneCheckCalibration()}),e(document).on("hcCalibrationEnd",function(t,a){e(document).trigger("hcHeadphoneCheckStart",{data:P,config:L})}),e(document).on("hcHeadphoneCheckStart",function(e,a){t.renderHeadphoneCheckPage()}),t.loadStimuli(L.jsonPath)},t.loadStimuli=function(t){if(e(document).on("hcLoadStimuliSuccess",function(t,a){var i=a.data;P.jsonData=i,L.doShuffleTrials&&g(i.stimuli,L.totalTrials,L.sampleWithReplacement),L.doCalibration&&(P.calibration=i.calibration),P.lastPage=Math.ceil(P.stimDataList.length/L.trialsPerPage),L.doCalibration?e(document).trigger("hcCalibrationStart",{data:P,config:L}):e(document).trigger("hcHeadphoneCheckStart",{data:P,config:L})}),t===a){var i={stimuli:[{id:1,src:"https://s3.amazonaws.com/mcd-headphone-check/v1.0/assets/antiphase_HC_ISO.wav",correct:"2"},{id:2,src:"https://s3.amazonaws.com/mcd-headphone-check/v1.0/assets/antiphase_HC_IOS.wav",correct:"3"},{id:3,src:"https://s3.amazonaws.com/mcd-headphone-check/v1.0/assets/antiphase_HC_SOI.wav",correct:"1"},{id:4,src:"https://s3.amazonaws.com/mcd-headphone-check/v1.0/assets/antiphase_HC_SIO.wav",correct:"1"},{id:5,src:"https://s3.amazonaws.com/mcd-headphone-check/v1.0/assets/antiphase_HC_OSI.wav",correct:"2"},{id:6,src:"https://s3.amazonaws.com/mcd-headphone-check/v1.0/assets/antiphase_HC_OIS.wav",correct:"3"}],calibration:{src:"https://s3.amazonaws.com/mcd-headphone-check/v1.0/assets/noise_calib_stim.wav"}};e(document).trigger("hcLoadStimuliSuccess",{data:i,config:L,status:"loadedDefault",error:void 0})}else e.ajax({dataType:"json",url:t,async:!0,success:function(t,a,i){e(document).trigger("hcLoadStimuliSuccess",{data:t,config:L,status:a,error:i})},error:function(t,a,i){e(document).trigger("hcLoadStimuliFail",{data:t,config:L,status:a,error:i})},complete:function(t,a,i){e(document).trigger("hcLoadStimuliDone",{data:t,config:L,status:a,error:i})}})},t.renderHeadphoneCheckPage=function(){for(e("<div/>",{class:"hc-instruction",html:"When you hit <b>Play</b>, you will hear three sounds separated by silences."}).appendTo(e("#hc-container")),e("<div/>",{class:"hc-instruction",text:"Simply judge WHICH SOUND WAS SOFTEST (quietest) -- 1, 2, or 3?"}).appendTo(e("#hc-container")),e("<div/>",{class:"hc-instruction",text:"Test sounds can only be played once!"}).appendTo(e("#hc-container")),L.debug&&console.log(P),i=0;i<L.trialsPerPage;i++){var r=P.pageNum*L.trialsPerPage+i;if(r<L.totalTrials){var c=P.stimDataList[r],s=P.stimIDList[r];n("hc-container",s,c.src)}}y&&e(".hc-buttonset-vertical").click(function(t){var i=e(t.target).parents().filter(".hc-trial-div").find("button");e(i).prop("disabled")||(e(i).parent().css("border","3px solid "+k),t.preventDefault());f(this.id.slice(this.id.indexOf("hc-radio-buttonset-")+"hc-radio-buttonset-".length))!==a&&i.parent().parent().css("border-color",S)}),e("<button/>",{text:"Continue",click:function(){var i=h();for(s=0;s<L.trialsPerPage;s++){var n=P.pageNum*L.trialsPerPage+s,r=f(P.stimIDList[n]);b(n,P.stimDataList[n],r)}if(i)if(P.pageNum==P.lastPage-1){if(1==L.totalTrials&&P.trialScoreList[0]===a)return void u();o();var c=p(L.correctThreshold);P.totalCorrect=m(P.trialScoreList),P.didPass=c,e(document).trigger("hcHeadphoneCheckEnd",{didPass:c,data:P,config:L})}else o(),P.pageNum++,t.renderHeadphoneCheckPage();else u()}}).appendTo(e("#hc-container"))},t.renderHeadphoneCheckCalibration=function(){e("<div/>",{class:"hc-calibration-instruction",text:"You must be wearing headphones to be able to complete this task!"}).appendTo(e("#hc-container")),e("<div/>",{class:"hc-calibration-instruction",text:"Level Calibration"}).appendTo(e("#hc-container")),e("<div/>",{class:"hc-calibration-instruction",text:"First, set your computer volume to about 25% of maximum."}).appendTo(e("#hc-container")),e("<div/>",{class:"hc-calibration-instruction",text:"Press the button, then turn up the volume on your computer until the calibration noise is at a loud but comfortable level."}).appendTo(e("#hc-container")),e("<div/>",{id:"hc-calibration-div",text:"Play the calibration sound as many times as you like."}).appendTo(e("#hc-container")),e("<audio/>",{id:"hc-calibration-audio",src:P.calibration.src}).appendTo(e("#hc-calibration-div")),e("<button/>",{id:"hc-calibration-play-button",disabled:!1,click:function(){w||l("hc-calibration-audio")},text:"Play"}).css("display","block").appendTo(e("#hc-calibration-div")),e("<div/>",{class:"hc-calibration-instruction",html:"Press <b>Continue</b> when level calibration is complete."}).appendTo(e("#hc-container")),e("<button/>",{id:"hc-calibration-continue-button",class:"hc-calibration-instruction",disabled:!0,text:"Continue",click:function(){w=!1,o(),e(document).trigger("hcCalibrationEnd",{data:P,config:L})}}).appendTo(e("#hc-container"))}}(window.HeadphoneCheck=window.HeadphoneCheck||{},jQuery);